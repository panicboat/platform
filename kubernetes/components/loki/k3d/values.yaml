# Loki Log Aggregation Configuration for k3d
# Production-ready base configuration with k3d-specific overrides

# =============================================================================
# Deployment Mode
# =============================================================================
# TODO(production): Use "distributed" mode for high availability in production
deploymentMode: SingleBinary

# =============================================================================
# Loki Configuration
# =============================================================================
loki:
  # Disable multi-tenancy for simplicity in k3d
  # TODO(production): Enable auth for multi-tenant environments
  auth_enabled: false

  # -------------------------------------------------------------------------
  # Common Configuration
  # -------------------------------------------------------------------------
  commonConfig:
    # TODO(production): Increase replication_factor to 3 for HA
    replication_factor: 1

  # -------------------------------------------------------------------------
  # Storage Configuration
  # -------------------------------------------------------------------------
  storage:
    # TODO(production): Use S3 or MinIO for long-term storage
    # Example for S3:
    #   type: s3
    #   s3:
    #     endpoint: s3.amazonaws.com
    #     region: ap-northeast-1
    #     bucketnames: loki-logs
    type: 'filesystem'

  # -------------------------------------------------------------------------
  # Schema Configuration
  # -------------------------------------------------------------------------
  schemaConfig:
    configs:
      - from: 2024-01-01
        store: tsdb
        object_store: filesystem
        schema: v13
        index:
          prefix: index_
          period: 24h

  # -------------------------------------------------------------------------
  # Pattern Ingester
  # -------------------------------------------------------------------------
  pattern_ingester:
    enabled: true

  # -------------------------------------------------------------------------
  # Limits Configuration
  # -------------------------------------------------------------------------
  limits_config:
    allow_structured_metadata: true
    volume_enabled: true
    # OTLP configuration for receiving logs from OpenTelemetry Collector
    otlp_config:
      resource_attributes:
        attributes_config:
          - action: index_label
            attributes:
              - k8s.namespace.name
              - k8s.pod.name
              - k8s.container.name
              - service.name

# =============================================================================
# Single Binary Mode Configuration
# =============================================================================
singleBinary:
  # TODO(production): Increase replicas for HA
  replicas: 1
  persistence:
    enabled: true
    # TODO(production): Increase storage size based on log volume
    size: 5Gi
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 1
      memory: 1Gi

# =============================================================================
# Gateway
# =============================================================================
gateway:
  enabled: false

# =============================================================================
# Cache Configuration
# =============================================================================
results_cache:
  enabled: false

chunksCache:
  enabled: false

# =============================================================================
# Disable Other Components (for SingleBinary mode)
# =============================================================================
backend:
  replicas: 0
read:
  replicas: 0
write:
  replicas: 0

# =============================================================================
# Monitoring
# =============================================================================
monitoring:
  serviceMonitor:
    enabled: true
  selfMonitoring:
    enabled: false
    grafanaAgent:
      installOperator: false
