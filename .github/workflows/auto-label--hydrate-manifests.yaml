name: 'Auto Label - Hydrate Manifests'

on:
  pull_request:
    types: [labeled, synchronize]
    branches:
      - '**'

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  resolve-targets:
    name: 'Resolve Targets'
    runs-on: ubuntu-latest
    outputs:
      targets: ${{ steps.resolver.outputs.targets }}
      has-targets: ${{ steps.resolver.outputs.has-targets }}
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2.2.1
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Get PR information
        id: pr-info
        uses: jwalton/gh-find-current-pr@v1
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          state: all
        continue-on-error: true

      - name: Label Resolver
        id: resolver
        uses: panicboat/deploy-actions/label-resolver@main
        with:
          repository: ${{ github.repository }}
          pr-number: ${{ steps.pr-info.outputs.number }}
          github-token: ${{ steps.app-token.outputs.token }}
          config-path: 'workflow-config.yaml'

  hydrate-manifests:
    name: 'Hydrate Manifests'
    needs: resolve-targets
    if: |
      needs.resolve-targets.outputs.has-targets == 'true' &&
      contains(needs.resolve-targets.outputs.targets, '"stack":"helmfile"')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Tools
        uses: yowcow/setup-helmfile@v1
        with:
          helmfile-version: v0.162.0
          helm-version: v3.14.0

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: "5.3.0"

      - name: Initialize Helm Repos
        working-directory: kubernetes
        run: |
          helmfile repos

      - name: Hydrate Manifests
        working-directory: kubernetes
        run: |
          make hydrate ENV=${{ matrix.target.environment }}

      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code || echo "changes_exist=true" >> $GITHUB_OUTPUT

      - name: Commit and Push Changes
        if: steps.git-check.outputs.changes_exist == 'true'
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "chore(k8s): hydrate manifests"
          file_pattern: 'kubernetes/manifests/**'
